


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SkuService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.inventorymanagement.inventory.service</a>
</div>

<h1>Coverage Summary for Class: SkuService (com.inventorymanagement.inventory.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SkuService</td>
<td class="coverageStat">
  <span class="percent">
    5.3%
  </span>
  <span class="absValue">
    (2/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/98)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    2.2%
  </span>
  <span class="absValue">
    (6/268)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SkuService$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    5.3%
  </span>
  <span class="absValue">
    (2/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/98)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    2.2%
  </span>
  <span class="absValue">
    (6/268)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.inventorymanagement.inventory.service;
&nbsp;
&nbsp;import com.inventorymanagement.common.exception.BusinessException;
&nbsp;import com.inventorymanagement.common.exception.EntityNotFoundException;
&nbsp;import com.inventorymanagement.common.exception.InsufficientStockException;
&nbsp;import com.inventorymanagement.common.exception.ValidationException;
&nbsp;import com.inventorymanagement.inventory.model.Sku;
&nbsp;import com.inventorymanagement.inventory.model.SkuDto;
&nbsp;import com.inventorymanagement.inventory.model.SkuMapper;
&nbsp;import com.inventorymanagement.inventory.repository.SkuRepository;
&nbsp;import com.inventorymanagement.product.model.Product;
&nbsp;import com.inventorymanagement.product.repository.ProductRepository;
&nbsp;import jakarta.transaction.Transactional;
&nbsp;import jakarta.validation.Valid;
&nbsp;import jakarta.validation.constraints.NotNull;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.security.SecureRandom;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.format.DateTimeFormatter;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.cache.annotation.CacheEvict;
&nbsp;import org.springframework.cache.annotation.Cacheable;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;
&nbsp;/**
&nbsp; * Service class for managing SKU entities and business operations. Provides comprehensive SKU
&nbsp; * management including inventory tracking, stock operations, and automatic SKU code generation.
&nbsp; */
&nbsp;@Service
&nbsp;@Transactional
&nbsp;public class SkuService {
&nbsp;
<b class="fc">&nbsp;  private static final Logger logger = LoggerFactory.getLogger(SkuService.class);</b>
&nbsp;  private static final String SKU_ENTITY_NAME = &quot;SKU&quot;;
&nbsp;  private static final int MAX_SKU_CODE_RETRY_ATTEMPTS = 5;
&nbsp;  private static final String SKU_CODE_PREFIX = &quot;SKU&quot;;
<b class="fc">&nbsp;  private static final SecureRandom random = new SecureRandom();</b>
&nbsp;
&nbsp;  private final SkuRepository skuRepository;
&nbsp;  private final ProductRepository productRepository;
&nbsp;  private final InventoryService inventoryService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  public SkuService(
&nbsp;      SkuRepository skuRepository,
&nbsp;      ProductRepository productRepository,
<b class="fc">&nbsp;      InventoryService inventoryService) {</b>
<b class="fc">&nbsp;    this.skuRepository = skuRepository;</b>
<b class="fc">&nbsp;    this.productRepository = productRepository;</b>
<b class="fc">&nbsp;    this.inventoryService = inventoryService;</b>
&nbsp;  }
&nbsp;
&nbsp;  // ===== CRUD OPERATIONS =====
&nbsp;
&nbsp;  /**
&nbsp;   * Creates a new SKU with business rule validation and automatic SKU code generation.
&nbsp;   *
&nbsp;   * @param skuDto the SKU data
&nbsp;   * @return the created SKU DTO
&nbsp;   * @throws ValidationException if validation fails
&nbsp;   * @throws EntityNotFoundException if product not found
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public SkuDto createSku(@Valid @NotNull SkuDto skuDto) {
<b class="nc">&nbsp;    logger.info(&quot;Creating new SKU for product: {}&quot;, skuDto.getProductId());</b>
&nbsp;
<b class="nc">&nbsp;    validateSkuForCreation(skuDto);</b>
&nbsp;
<b class="nc">&nbsp;    Sku sku = SkuMapper.toEntity(skuDto);</b>
&nbsp;
&nbsp;    // Set up product relationship
<b class="nc">&nbsp;    Product product = findProductById(skuDto.getProductId());</b>
<b class="nc">&nbsp;    validateProductForSku(product);</b>
<b class="nc">&nbsp;    sku.setProduct(product);</b>
&nbsp;
&nbsp;    // Generate SKU code if not provided
<b class="nc">&nbsp;    if (!StringUtils.hasText(sku.getSkuCode())) {</b>
<b class="nc">&nbsp;      String generatedSkuCode = generateUniqueSkuCode(product);</b>
<b class="nc">&nbsp;      sku.setSkuCode(generatedSkuCode);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku savedSku = skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Create initial inventory transaction if stock quantity is set
<b class="nc">&nbsp;    if (savedSku.getStockQuantity() &gt; 0) {</b>
<b class="nc">&nbsp;      inventoryService.recordStockIn(</b>
<b class="nc">&nbsp;          savedSku.getId(),</b>
<b class="nc">&nbsp;          savedSku.getStockQuantity(),</b>
&nbsp;          &quot;INITIAL_STOCK&quot;,
&nbsp;          &quot;Initial stock creation&quot;,
&nbsp;          &quot;SYSTEM&quot;);
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    logger.info(</b>
&nbsp;        &quot;Successfully created SKU with ID: {} and code: {}&quot;,
<b class="nc">&nbsp;        savedSku.getId(),</b>
<b class="nc">&nbsp;        savedSku.getSkuCode());</b>
<b class="nc">&nbsp;    return SkuMapper.toDto(savedSku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Updates an existing SKU with business rule validation.
&nbsp;   *
&nbsp;   * @param id the SKU ID
&nbsp;   * @param skuDto the updated SKU data
&nbsp;   * @return the updated SKU DTO
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws ValidationException if validation fails
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public SkuDto updateSku(@NotNull Long id, @Valid @NotNull SkuDto skuDto) {
<b class="nc">&nbsp;    logger.info(&quot;Updating SKU with ID: {}&quot;, id);</b>
&nbsp;
<b class="nc">&nbsp;    Sku existingSku = findSkuById(id);</b>
<b class="nc">&nbsp;    validateSkuForUpdate(existingSku, skuDto);</b>
&nbsp;
&nbsp;    // Store original stock quantity for comparison
<b class="nc">&nbsp;    Integer originalStockQuantity = existingSku.getStockQuantity();</b>
&nbsp;
&nbsp;    // Update basic fields
<b class="nc">&nbsp;    existingSku.setVariantName(skuDto.getVariantName());</b>
<b class="nc">&nbsp;    existingSku.setSize(skuDto.getSize());</b>
<b class="nc">&nbsp;    existingSku.setColor(skuDto.getColor());</b>
<b class="nc">&nbsp;    existingSku.setPrice(skuDto.getPrice());</b>
<b class="nc">&nbsp;    existingSku.setCost(skuDto.getCost());</b>
<b class="nc">&nbsp;    existingSku.setReorderPoint(skuDto.getReorderPoint());</b>
<b class="nc">&nbsp;    existingSku.setReorderQuantity(skuDto.getReorderQuantity());</b>
<b class="nc">&nbsp;    existingSku.setBarcode(skuDto.getBarcode());</b>
<b class="nc">&nbsp;    existingSku.setLocation(skuDto.getLocation());</b>
<b class="nc">&nbsp;    existingSku.setMetadata(skuDto.getMetadata());</b>
&nbsp;
&nbsp;    // Handle stock quantity changes
<b class="nc">&nbsp;    if (!originalStockQuantity.equals(skuDto.getStockQuantity())) {</b>
<b class="nc">&nbsp;      int adjustment = skuDto.getStockQuantity() - originalStockQuantity;</b>
<b class="nc">&nbsp;      existingSku.setStockQuantity(skuDto.getStockQuantity());</b>
&nbsp;
&nbsp;      // Record inventory transaction for the adjustment
<b class="nc">&nbsp;      if (adjustment != 0) {</b>
<b class="nc">&nbsp;        inventoryService.recordStockAdjustment(</b>
<b class="nc">&nbsp;            existingSku.getId(),</b>
<b class="nc">&nbsp;            adjustment,</b>
&nbsp;            &quot;MANUAL_ADJUSTMENT&quot;,
&nbsp;            &quot;Manual stock adjustment&quot;,
&nbsp;            &quot;SYSTEM&quot;);
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    // Handle product change
<b class="nc">&nbsp;    if (shouldUpdateProduct(existingSku, skuDto)) {</b>
<b class="nc">&nbsp;      Product newProduct = findProductById(skuDto.getProductId());</b>
<b class="nc">&nbsp;      validateProductForSku(newProduct);</b>
<b class="nc">&nbsp;      existingSku.setProduct(newProduct);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku updatedSku = skuRepository.save(existingSku);</b>
<b class="nc">&nbsp;    logger.info(&quot;Successfully updated SKU with ID: {}&quot;, id);</b>
&nbsp;
<b class="nc">&nbsp;    return SkuMapper.toDto(updatedSku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Retrieves a SKU by ID.
&nbsp;   *
&nbsp;   * @param id the SKU ID
&nbsp;   * @return the SKU DTO
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   */
&nbsp;  @Cacheable(value = &quot;skus&quot;, key = &quot;#id&quot;)
&nbsp;  public SkuDto getSkuById(@NotNull Long id) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving SKU with ID: {}&quot;, id);</b>
<b class="nc">&nbsp;    Sku sku = findSkuById(id);</b>
<b class="nc">&nbsp;    return SkuMapper.toDto(sku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Retrieves a SKU by SKU code.
&nbsp;   *
&nbsp;   * @param skuCode the SKU code
&nbsp;   * @return the SKU DTO
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   */
&nbsp;  @Cacheable(value = &quot;skus&quot;, key = &quot;&#39;code:&#39; + #skuCode&quot;)
&nbsp;  public SkuDto getSkuByCode(@NotNull String skuCode) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving SKU with code: {}&quot;, skuCode);</b>
<b class="nc">&nbsp;    Sku sku =</b>
&nbsp;        skuRepository
<b class="nc">&nbsp;            .findBySkuCode(skuCode)</b>
<b class="nc">&nbsp;            .orElseThrow(() -&gt; new EntityNotFoundException(SKU_ENTITY_NAME, skuCode));</b>
<b class="nc">&nbsp;    return SkuMapper.toDto(sku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Retrieves all SKUs with pagination.
&nbsp;   *
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of SKU DTOs
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; getAllSkus(Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving all SKUs with pagination&quot;);</b>
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus = skuRepository.findAllActive(pageable);</b>
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Soft deletes a SKU.
&nbsp;   *
&nbsp;   * @param id the SKU ID
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws BusinessException if SKU has reserved stock
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public void deleteSku(@NotNull Long id) {
<b class="nc">&nbsp;    logger.info(&quot;Deleting SKU with ID: {}&quot;, id);</b>
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(id);</b>
<b class="nc">&nbsp;    validateSkuForDeletion(sku);</b>
&nbsp;
&nbsp;    // Release any reserved stock before deletion
<b class="nc">&nbsp;    if (sku.getReservedQuantity() &gt; 0) {</b>
<b class="nc">&nbsp;      sku.releaseReservedStock(sku.getReservedQuantity());</b>
<b class="nc">&nbsp;      inventoryService.recordStockRelease(</b>
<b class="nc">&nbsp;          sku.getId(),</b>
<b class="nc">&nbsp;          sku.getReservedQuantity(),</b>
&nbsp;          null,
&nbsp;          &quot;DELETION&quot;,
&nbsp;          &quot;Stock released due to SKU deletion&quot;,
&nbsp;          &quot;SYSTEM&quot;);
&nbsp;    }
&nbsp;
&nbsp;    // Soft delete the SKU
<b class="nc">&nbsp;    sku.markAsDeleted();</b>
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully deleted SKU with ID: {}&quot;, id);</b>
&nbsp;  }
&nbsp;
&nbsp;  // ===== PRODUCT-BASED OPERATIONS =====
&nbsp;
&nbsp;  /**
&nbsp;   * Retrieves all SKUs for a specific product.
&nbsp;   *
&nbsp;   * @param productId the product ID
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of SKU DTOs
&nbsp;   * @throws EntityNotFoundException if product not found
&nbsp;   */
&nbsp;  @Cacheable(
&nbsp;      value = &quot;skus&quot;,
&nbsp;      key = &quot;&#39;product:&#39; + #productId + &#39;:&#39; + #pageable.pageNumber + &#39;:&#39; + #pageable.pageSize&quot;)
&nbsp;  public Page&lt;SkuDto&gt; getSkusByProduct(@NotNull Long productId, Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving SKUs for product ID: {}&quot;, productId);</b>
&nbsp;
&nbsp;    // Verify product exists
<b class="nc">&nbsp;    findProductById(productId);</b>
&nbsp;
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus = skuRepository.findByProductId(productId, pageable);</b>
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Retrieves all active SKUs for a specific product.
&nbsp;   *
&nbsp;   * @param productId the product ID
&nbsp;   * @return list of active SKU DTOs
&nbsp;   * @throws EntityNotFoundException if product not found
&nbsp;   */
&nbsp;  public List&lt;SkuDto&gt; getActiveSkusByProduct(@NotNull Long productId) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving active SKUs for product ID: {}&quot;, productId);</b>
&nbsp;
&nbsp;    // Verify product exists
<b class="nc">&nbsp;    findProductById(productId);</b>
&nbsp;
<b class="nc">&nbsp;    List&lt;Sku&gt; skus = skuRepository.findActiveByProductId(productId);</b>
<b class="nc">&nbsp;    return skus.stream().map(SkuMapper::toDto).toList();</b>
&nbsp;  }
&nbsp;
&nbsp;  // ===== INVENTORY OPERATIONS =====
&nbsp;
&nbsp;  /**
&nbsp;   * Reserves stock for a SKU.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param quantity the quantity to reserve
&nbsp;   * @param referenceId the reference ID for the reservation
&nbsp;   * @param referenceType the reference type (e.g., &quot;ORDER&quot;, &quot;ALLOCATION&quot;)
&nbsp;   * @param reason the reason for the reservation
&nbsp;   * @param performedBy who performed the reservation
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws InsufficientStockException if insufficient stock available
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public void reserveStock(
&nbsp;      @NotNull Long skuId,
&nbsp;      @NotNull Integer quantity,
&nbsp;      String referenceId,
&nbsp;      String referenceType,
&nbsp;      String reason,
&nbsp;      String performedBy) {
<b class="nc">&nbsp;    logger.info(&quot;Reserving {} units of stock for SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (quantity &lt;= 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;quantity&quot;, &quot;Quantity must be positive&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (!sku.getIsActive()) {</b>
<b class="nc">&nbsp;      throw new BusinessException(&quot;Cannot reserve stock for inactive SKU&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (!sku.reserveStock(quantity)) {</b>
<b class="nc">&nbsp;      throw new InsufficientStockException(sku.getSkuCode(), quantity, sku.getAvailableQuantity());</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockReservation(</b>
&nbsp;        skuId, quantity, referenceId, referenceType, reason, performedBy);
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully reserved {} units for SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Releases reserved stock for a SKU.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param quantity the quantity to release
&nbsp;   * @param referenceId the reference ID for the release
&nbsp;   * @param referenceType the reference type
&nbsp;   * @param reason the reason for the release
&nbsp;   * @param performedBy who performed the release
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public void releaseReservedStock(
&nbsp;      @NotNull Long skuId,
&nbsp;      @NotNull Integer quantity,
&nbsp;      String referenceId,
&nbsp;      String referenceType,
&nbsp;      String reason,
&nbsp;      String performedBy) {
<b class="nc">&nbsp;    logger.info(&quot;Releasing {} units of reserved stock for SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (quantity &lt;= 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;quantity&quot;, &quot;Quantity must be positive&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
<b class="nc">&nbsp;    Integer actualReleased = sku.releaseReservedStock(quantity);</b>
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockRelease(</b>
&nbsp;        skuId, actualReleased, referenceId, referenceType, reason, performedBy);
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully released {} units for SKU ID: {}&quot;, actualReleased, skuId);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Fulfills an order by reducing both stock and reserved quantities.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param quantity the quantity to fulfill
&nbsp;   * @param referenceId the reference ID for the fulfillment
&nbsp;   * @param referenceType the reference type (e.g., &quot;ORDER&quot;, &quot;SHIPMENT&quot;)
&nbsp;   * @param reason the reason for the fulfillment
&nbsp;   * @param performedBy who performed the fulfillment
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws InsufficientStockException if insufficient reserved stock
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public void fulfillOrder(
&nbsp;      @NotNull Long skuId,
&nbsp;      @NotNull Integer quantity,
&nbsp;      String referenceId,
&nbsp;      String referenceType,
&nbsp;      String reason,
&nbsp;      String performedBy) {
<b class="nc">&nbsp;    logger.info(&quot;Fulfilling order for {} units of SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (quantity &lt;= 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;quantity&quot;, &quot;Quantity must be positive&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (!sku.fulfillOrder(quantity)) {</b>
<b class="nc">&nbsp;      throw new InsufficientStockException(sku.getSkuCode(), quantity, sku.getReservedQuantity());</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockOut(</b>
&nbsp;        skuId, quantity, referenceId, referenceType, reason, performedBy);
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully fulfilled order for {} units of SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Adjusts stock quantity for a SKU.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param adjustment the adjustment amount (positive for increase, negative for decrease)
&nbsp;   * @param reason the reason for the adjustment
&nbsp;   * @param performedBy who performed the adjustment
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public void adjustStock(
&nbsp;      @NotNull Long skuId, @NotNull Integer adjustment, String reason, String performedBy) {
<b class="nc">&nbsp;    logger.info(&quot;Adjusting stock by {} units for SKU ID: {}&quot;, adjustment, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (adjustment == 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;adjustment&quot;, &quot;Adjustment cannot be zero&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
<b class="nc">&nbsp;    Integer newQuantity = sku.adjustStock(adjustment);</b>
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockAdjustment(</b>
&nbsp;        skuId, adjustment, &quot;MANUAL_ADJUSTMENT&quot;, reason, performedBy);
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully adjusted stock to {} units for SKU ID: {}&quot;, newQuantity, skuId);</b>
&nbsp;  }
&nbsp;
&nbsp;  // ===== SEARCH AND FILTER OPERATIONS =====
&nbsp;
&nbsp;  /**
&nbsp;   * Searches SKUs by various criteria.
&nbsp;   *
&nbsp;   * @param searchTerm the search term for SKU code or variant name
&nbsp;   * @param productId the product ID filter (optional)
&nbsp;   * @param isActive the active status filter (optional)
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of matching SKU DTOs
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; searchSkus(
&nbsp;      String searchTerm, Long productId, Boolean isActive, Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(</b>
&nbsp;        &quot;Searching SKUs with criteria - searchTerm: {}, productId: {}, isActive: {}&quot;,
&nbsp;        searchTerm,
&nbsp;        productId,
&nbsp;        isActive);
&nbsp;
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus =</b>
<b class="nc">&nbsp;        skuRepository.findWithExtendedFilters(</b>
&nbsp;            searchTerm, productId, null, null, null, isActive, null, pageable);
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Searches SKUs with extended criteria.
&nbsp;   *
&nbsp;   * @param skuCode filter by SKU code (optional)
&nbsp;   * @param productId filter by product ID (optional)
&nbsp;   * @param variantName filter by variant name (optional)
&nbsp;   * @param minPrice filter by minimum price (optional)
&nbsp;   * @param maxPrice filter by maximum price (optional)
&nbsp;   * @param isActive filter by active status (optional)
&nbsp;   * @param isLowStock filter by low stock status (optional)
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of matching SKU DTOs
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; searchSkus(
&nbsp;      String skuCode,
&nbsp;      Long productId,
&nbsp;      String variantName,
&nbsp;      BigDecimal minPrice,
&nbsp;      BigDecimal maxPrice,
&nbsp;      Boolean isActive,
&nbsp;      Boolean isLowStock,
&nbsp;      Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(</b>
&nbsp;        &quot;Searching SKUs with extended criteria - skuCode: {}, productId: {}, variantName: {}, minPrice: {}, maxPrice: {}, isActive: {}, isLowStock: {}&quot;,
&nbsp;        skuCode,
&nbsp;        productId,
&nbsp;        variantName,
&nbsp;        minPrice,
&nbsp;        maxPrice,
&nbsp;        isActive,
&nbsp;        isLowStock);
&nbsp;
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus =</b>
<b class="nc">&nbsp;        skuRepository.findWithExtendedFilters(</b>
&nbsp;            skuCode, productId, variantName, minPrice, maxPrice, isActive, isLowStock, pageable);
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Searches SKUs by code or variant name.
&nbsp;   *
&nbsp;   * @param query the search query
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of matching SKU DTOs
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; searchSkusByCodeOrVariant(@NotNull String query, Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(&quot;Searching SKUs by code or variant: {}&quot;, query);</b>
&nbsp;
<b class="nc">&nbsp;    if (!StringUtils.hasText(query)) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;query&quot;, &quot;Search query cannot be empty&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus = skuRepository.findBySkuCodeOrVariantNameContainingIgnoreCase(query, pageable);</b>
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Gets SKUs with low stock.
&nbsp;   *
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of low stock SKU DTOs
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; getLowStockSkus(Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving low stock SKUs&quot;);</b>
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus = skuRepository.findLowStockSkus(pageable);</b>
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Adds stock to a SKU.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param quantity the quantity to add
&nbsp;   * @return updated SKU DTO
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws ValidationException if quantity is invalid
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public SkuDto addStock(@NotNull Long skuId, @NotNull Integer quantity) {
<b class="nc">&nbsp;    logger.info(&quot;Adding {} stock to SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (quantity &lt;= 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;quantity&quot;, &quot;Quantity must be positive&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
<b class="nc">&nbsp;    sku.adjustStock(quantity);</b>
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockAdjustment(</b>
&nbsp;        skuId, quantity, &quot;STOCK_ADDITION&quot;, &quot;Manual stock addition&quot;, &quot;SYSTEM&quot;);
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully added {} stock to SKU ID: {}&quot;, quantity, skuId);</b>
<b class="nc">&nbsp;    return SkuMapper.toDto(sku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Removes stock from a SKU.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param quantity the quantity to remove
&nbsp;   * @return updated SKU DTO
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws ValidationException if quantity is invalid
&nbsp;   * @throws InsufficientStockException if insufficient stock
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public SkuDto removeStock(@NotNull Long skuId, @NotNull Integer quantity) {
<b class="nc">&nbsp;    logger.info(&quot;Removing {} stock from SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (quantity &lt;= 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;quantity&quot;, &quot;Quantity must be positive&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (sku.getStockQuantity() &lt; quantity) {</b>
<b class="nc">&nbsp;      throw new InsufficientStockException(sku.getSkuCode(), quantity, sku.getStockQuantity());</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    sku.adjustStock(-quantity);</b>
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockAdjustment(</b>
<b class="nc">&nbsp;        skuId, -quantity, &quot;STOCK_REMOVAL&quot;, &quot;Manual stock removal&quot;, &quot;SYSTEM&quot;);</b>
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully removed {} stock from SKU ID: {}&quot;, quantity, skuId);</b>
<b class="nc">&nbsp;    return SkuMapper.toDto(sku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Reserves stock for a SKU.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param quantity the quantity to reserve
&nbsp;   * @return updated SKU DTO
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws ValidationException if quantity is invalid
&nbsp;   * @throws InsufficientStockException if insufficient stock
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public SkuDto reserveStock(@NotNull Long skuId, @NotNull Integer quantity) {
<b class="nc">&nbsp;    logger.info(&quot;Reserving {} stock for SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (quantity &lt;= 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;quantity&quot;, &quot;Quantity must be positive&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (!sku.getIsActive()) {</b>
<b class="nc">&nbsp;      throw new BusinessException(&quot;Cannot reserve stock for inactive SKU&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (!sku.reserveStock(quantity)) {</b>
<b class="nc">&nbsp;      throw new InsufficientStockException(sku.getSkuCode(), quantity, sku.getAvailableQuantity());</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockReservation(</b>
&nbsp;        skuId, quantity, null, &quot;MANUAL_RESERVATION&quot;, &quot;Manual stock reservation&quot;, &quot;SYSTEM&quot;);
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully reserved {} stock for SKU ID: {}&quot;, quantity, skuId);</b>
<b class="nc">&nbsp;    return SkuMapper.toDto(sku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Releases reserved stock for a SKU.
&nbsp;   *
&nbsp;   * @param skuId the SKU ID
&nbsp;   * @param quantity the quantity to release
&nbsp;   * @return updated SKU DTO
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   * @throws ValidationException if quantity is invalid
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public SkuDto releaseStock(@NotNull Long skuId, @NotNull Integer quantity) {
<b class="nc">&nbsp;    logger.info(&quot;Releasing {} reserved stock for SKU ID: {}&quot;, quantity, skuId);</b>
&nbsp;
<b class="nc">&nbsp;    if (quantity &lt;= 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;quantity&quot;, &quot;Quantity must be positive&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(skuId);</b>
<b class="nc">&nbsp;    Integer actualReleased = sku.releaseReservedStock(quantity);</b>
&nbsp;
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
&nbsp;    // Record inventory transaction
<b class="nc">&nbsp;    inventoryService.recordStockRelease(</b>
&nbsp;        skuId, actualReleased, null, &quot;MANUAL_RELEASE&quot;, &quot;Manual stock release&quot;, &quot;SYSTEM&quot;);
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully released {} reserved stock for SKU ID: {}&quot;, actualReleased, skuId);</b>
<b class="nc">&nbsp;    return SkuMapper.toDto(sku);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Finds SKUs with low stock (below reorder point).
&nbsp;   *
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of SKU DTOs with low stock
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; getSkusWithLowStock(Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving SKUs with low stock&quot;);</b>
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus = skuRepository.findLowStockSkus(pageable);</b>
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Finds SKUs that are out of stock.
&nbsp;   *
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of SKU DTOs that are out of stock
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; getOutOfStockSkus(Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving out of stock SKUs&quot;);</b>
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus = skuRepository.findOutOfStockSkus(pageable);</b>
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Finds SKUs in a price range.
&nbsp;   *
&nbsp;   * @param minPrice the minimum price
&nbsp;   * @param maxPrice the maximum price
&nbsp;   * @param pageable pagination information
&nbsp;   * @return page of SKU DTOs in the price range
&nbsp;   */
&nbsp;  public Page&lt;SkuDto&gt; getSkusByPriceRange(
&nbsp;      @NotNull BigDecimal minPrice, @NotNull BigDecimal maxPrice, Pageable pageable) {
<b class="nc">&nbsp;    logger.debug(&quot;Retrieving SKUs in price range: {} - {}&quot;, minPrice, maxPrice);</b>
&nbsp;
<b class="nc">&nbsp;    if (minPrice.compareTo(maxPrice) &gt; 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(</b>
&nbsp;          &quot;priceRange&quot;, &quot;Minimum price cannot be greater than maximum price&quot;);
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Page&lt;Sku&gt; skus = skuRepository.findByPriceRange(minPrice, maxPrice, pageable);</b>
<b class="nc">&nbsp;    return skus.map(SkuMapper::toDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  // ===== BUSINESS LOGIC METHODS =====
&nbsp;
&nbsp;  /**
&nbsp;   * Activates a SKU.
&nbsp;   *
&nbsp;   * @param id the SKU ID
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public void activateSku(@NotNull Long id) {
<b class="nc">&nbsp;    logger.info(&quot;Activating SKU with ID: {}&quot;, id);</b>
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(id);</b>
&nbsp;
&nbsp;    // Validate that product is active
<b class="nc">&nbsp;    if (!sku.getProduct().getIsActive()) {</b>
<b class="nc">&nbsp;      throw new BusinessException(&quot;Cannot activate SKU for inactive product&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    sku.activate();</b>
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully activated SKU with ID: {}&quot;, id);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Deactivates a SKU.
&nbsp;   *
&nbsp;   * @param id the SKU ID
&nbsp;   * @throws EntityNotFoundException if SKU not found
&nbsp;   */
&nbsp;  @CacheEvict(
&nbsp;      value = {&quot;skus&quot;, &quot;inventory&quot;},
&nbsp;      allEntries = true)
&nbsp;  public void deactivateSku(@NotNull Long id) {
<b class="nc">&nbsp;    logger.info(&quot;Deactivating SKU with ID: {}&quot;, id);</b>
&nbsp;
<b class="nc">&nbsp;    Sku sku = findSkuById(id);</b>
&nbsp;
&nbsp;    // Release any reserved stock before deactivation
<b class="nc">&nbsp;    if (sku.getReservedQuantity() &gt; 0) {</b>
<b class="nc">&nbsp;      sku.releaseReservedStock(sku.getReservedQuantity());</b>
<b class="nc">&nbsp;      inventoryService.recordStockRelease(</b>
<b class="nc">&nbsp;          sku.getId(),</b>
<b class="nc">&nbsp;          sku.getReservedQuantity(),</b>
&nbsp;          null,
&nbsp;          &quot;DEACTIVATION&quot;,
&nbsp;          &quot;Stock released due to SKU deactivation&quot;,
&nbsp;          &quot;SYSTEM&quot;);
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    sku.deactivate();</b>
<b class="nc">&nbsp;    skuRepository.save(sku);</b>
&nbsp;
<b class="nc">&nbsp;    logger.info(&quot;Successfully deactivated SKU with ID: {}&quot;, id);</b>
&nbsp;  }
&nbsp;
&nbsp;  // ===== PRIVATE HELPER METHODS =====
&nbsp;
&nbsp;  private Sku findSkuById(Long id) {
<b class="nc">&nbsp;    return skuRepository</b>
<b class="nc">&nbsp;        .findById(id)</b>
<b class="nc">&nbsp;        .orElseThrow(() -&gt; new EntityNotFoundException(SKU_ENTITY_NAME, id));</b>
&nbsp;  }
&nbsp;
&nbsp;  private Product findProductById(Long id) {
<b class="nc">&nbsp;    return productRepository</b>
<b class="nc">&nbsp;        .findById(id)</b>
<b class="nc">&nbsp;        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Product&quot;, id));</b>
&nbsp;  }
&nbsp;
&nbsp;  private void validateSkuForCreation(SkuDto skuDto) {
<b class="nc">&nbsp;    if (skuDto.getProductId() == null) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;productId&quot;, &quot;Product is required&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (skuDto.getPrice() == null || skuDto.getPrice().compareTo(BigDecimal.ZERO) &lt; 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;price&quot;, &quot;Price is required and must be non-negative&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    // Check for duplicate SKU code if provided
<b class="nc">&nbsp;    if (StringUtils.hasText(skuDto.getSkuCode())) {</b>
<b class="nc">&nbsp;      Optional&lt;Sku&gt; existing = skuRepository.findBySkuCode(skuDto.getSkuCode());</b>
<b class="nc">&nbsp;      if (existing.isPresent()) {</b>
<b class="nc">&nbsp;        throw new ValidationException(&quot;skuCode&quot;, &quot;SKU code already exists&quot;);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    // Validate stock quantities
<b class="nc">&nbsp;    validateStockQuantities(skuDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void validateSkuForUpdate(Sku existingSku, SkuDto skuDto) {
<b class="nc">&nbsp;    if (skuDto.getProductId() == null) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;productId&quot;, &quot;Product is required&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (skuDto.getPrice() == null || skuDto.getPrice().compareTo(BigDecimal.ZERO) &lt; 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;price&quot;, &quot;Price is required and must be non-negative&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    // Check for duplicate SKU code if changed
<b class="nc">&nbsp;    if (StringUtils.hasText(skuDto.getSkuCode())</b>
<b class="nc">&nbsp;        &amp;&amp; !existingSku.getSkuCode().equals(skuDto.getSkuCode())) {</b>
<b class="nc">&nbsp;      Optional&lt;Sku&gt; existing = skuRepository.findBySkuCode(skuDto.getSkuCode());</b>
<b class="nc">&nbsp;      if (existing.isPresent()) {</b>
<b class="nc">&nbsp;        throw new ValidationException(&quot;skuCode&quot;, &quot;SKU code already exists&quot;);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    // Validate stock quantities
<b class="nc">&nbsp;    validateStockQuantities(skuDto);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void validateStockQuantities(SkuDto skuDto) {
<b class="nc">&nbsp;    if (skuDto.getStockQuantity() != null &amp;&amp; skuDto.getStockQuantity() &lt; 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;stockQuantity&quot;, &quot;Stock quantity cannot be negative&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (skuDto.getReservedQuantity() != null &amp;&amp; skuDto.getReservedQuantity() &lt; 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;reservedQuantity&quot;, &quot;Reserved quantity cannot be negative&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (skuDto.getReorderPoint() != null &amp;&amp; skuDto.getReorderPoint() &lt; 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;reorderPoint&quot;, &quot;Reorder point cannot be negative&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (skuDto.getReorderQuantity() != null &amp;&amp; skuDto.getReorderQuantity() &lt; 0) {</b>
<b class="nc">&nbsp;      throw new ValidationException(&quot;reorderQuantity&quot;, &quot;Reorder quantity cannot be negative&quot;);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void validateProductForSku(Product product) {
<b class="nc">&nbsp;    if (!product.getIsActive()) {</b>
<b class="nc">&nbsp;      throw new BusinessException(&quot;Cannot create SKU for inactive product&quot;);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void validateSkuForDeletion(Sku sku) {
&nbsp;    // Can delete SKU even if it has reserved stock, but we&#39;ll release it first
&nbsp;    // This is a business decision - could be stricter if needed
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  private boolean shouldUpdateProduct(Sku existingSku, SkuDto skuDto) {
<b class="nc">&nbsp;    return !existingSku.getProduct().getId().equals(skuDto.getProductId());</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Generates a unique SKU code with retry logic.
&nbsp;   *
&nbsp;   * @param product the product for which to generate the SKU code
&nbsp;   * @return unique SKU code
&nbsp;   * @throws BusinessException if unable to generate unique code after max retries
&nbsp;   */
&nbsp;  private String generateUniqueSkuCode(Product product) {
<b class="nc">&nbsp;    String baseCode = generateBaseSkuCode(product);</b>
&nbsp;
<b class="nc">&nbsp;    for (int attempt = 0; attempt &lt; MAX_SKU_CODE_RETRY_ATTEMPTS; attempt++) {</b>
<b class="nc">&nbsp;      String skuCode = baseCode + generateRandomSuffix();</b>
&nbsp;
<b class="nc">&nbsp;      if (skuRepository.findBySkuCode(skuCode).isEmpty()) {</b>
<b class="nc">&nbsp;        return skuCode;</b>
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    throw new BusinessException(</b>
&nbsp;        &quot;Unable to generate unique SKU code after &quot; + MAX_SKU_CODE_RETRY_ATTEMPTS + &quot; attempts&quot;);
&nbsp;  }
&nbsp;
&nbsp;  private String generateBaseSkuCode(Product product) {
<b class="nc">&nbsp;    StringBuilder codeBuilder = new StringBuilder();</b>
&nbsp;
&nbsp;    // Add prefix
<b class="nc">&nbsp;    codeBuilder.append(SKU_CODE_PREFIX);</b>
&nbsp;
&nbsp;    // Add category abbreviation if available
<b class="nc">&nbsp;    if (product.getCategory() != null &amp;&amp; StringUtils.hasText(product.getCategory().getName())) {</b>
<b class="nc">&nbsp;      String categoryAbbr =</b>
&nbsp;          product
<b class="nc">&nbsp;              .getCategory()</b>
<b class="nc">&nbsp;              .getName()</b>
<b class="nc">&nbsp;              .toUpperCase()</b>
<b class="nc">&nbsp;              .replaceAll(&quot;[^A-Z0-9]&quot;, &quot;&quot;)</b>
<b class="nc">&nbsp;              .substring(0, Math.min(3, product.getCategory().getName().length()));</b>
<b class="nc">&nbsp;      codeBuilder.append(categoryAbbr);</b>
&nbsp;    }
&nbsp;
&nbsp;    // Add product abbreviation if available
<b class="nc">&nbsp;    if (StringUtils.hasText(product.getName())) {</b>
<b class="nc">&nbsp;      String productAbbr =</b>
&nbsp;          product
<b class="nc">&nbsp;              .getName()</b>
<b class="nc">&nbsp;              .toUpperCase()</b>
<b class="nc">&nbsp;              .replaceAll(&quot;[^A-Z0-9]&quot;, &quot;&quot;)</b>
<b class="nc">&nbsp;              .substring(0, Math.min(3, product.getName().length()));</b>
<b class="nc">&nbsp;      codeBuilder.append(productAbbr);</b>
&nbsp;    }
&nbsp;
&nbsp;    // Add date component
<b class="nc">&nbsp;    String dateComponent = LocalDate.now().format(DateTimeFormatter.ofPattern(&quot;yyMMdd&quot;));</b>
<b class="nc">&nbsp;    codeBuilder.append(dateComponent);</b>
&nbsp;
<b class="nc">&nbsp;    return codeBuilder.toString();</b>
&nbsp;  }
&nbsp;
&nbsp;  private String generateRandomSuffix() {
<b class="nc">&nbsp;    return String.format(&quot;%03d&quot;, random.nextInt(1000));</b>
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-19 20:52</div>
</div>
</body>
</html>
