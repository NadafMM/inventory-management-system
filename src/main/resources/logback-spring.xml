<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <!-- Define properties for configuration -->
  <appender class="ch.qos.logback.core.rolling.RollingFileAppender" name="FILE">
    <encoder class="net.logstash.logback.encoder.LogstashEncoder">
      <customFields>{"service":"${APP_NAME}","logType":"application"}</customFields>
      <includeContext>true</includeContext>
      <includeMdc>true</includeMdc>
    </encoder>
    <file>${LOG_DIR}/${APP_NAME}.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${LOG_DIR}/${APP_NAME}.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
      <maxFileSize>100MB</maxFileSize>
      <maxHistory>30</maxHistory>
      <totalSizeCap>10GB</totalSizeCap>
    </rollingPolicy>
  </appender>
  <appender class="ch.qos.logback.classic.AsyncAppender" name="ASYNC_FILE">
    <appender-ref ref="FILE"/>
    <discardingThreshold>20</discardingThreshold>
    <includeCallerData>false</includeCallerData>
    <maxFlushTime>2000</maxFlushTime>
    <neverBlock>true</neverBlock>
    <queueSize>512</queueSize>
  </appender>

  <appender class="ch.qos.logback.core.rolling.RollingFileAppender" name="ERROR_FILE">
    <encoder class="net.logstash.logback.encoder.LogstashEncoder">
      <customFields>{"service":"${APP_NAME}","logType":"error"}</customFields>
      <includeContext>true</includeContext>
      <includeMdc>true</includeMdc>
      <includeStackTrace>true</includeStackTrace>
    </encoder>
    <file>${LOG_DIR}/${APP_NAME}-error.log</file>
    <filter class="ch.qos.logback.classic.filter.LevelFilter">
      <level>ERROR</level>
      <onMatch>ACCEPT</onMatch>
      <onMismatch>DENY</onMismatch>
    </filter>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${LOG_DIR}/${APP_NAME}-error.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
      <maxFileSize>50MB</maxFileSize>
      <maxHistory>60</maxHistory>
      <totalSizeCap>5GB</totalSizeCap>
    </rollingPolicy>
  </appender>
  <appender class="ch.qos.logback.classic.AsyncAppender" name="ASYNC_ERROR_FILE">
    <appender-ref ref="ERROR_FILE"/>
    <discardingThreshold>0</discardingThreshold>
    <includeCallerData>true</includeCallerData>
    <maxFlushTime>2000</maxFlushTime>
    <neverBlock>false</neverBlock>
    <queueSize>256</queueSize>
  </appender>
  <appender class="ch.qos.logback.core.rolling.RollingFileAppender" name="PERFORMANCE_FILE">
    <encoder class="net.logstash.logback.encoder.LogstashEncoder">
      <customFields>{"service":"${APP_NAME}","logType":"performance"}</customFields>
      <includeContext>true</includeContext>
      <includeMdc>true</includeMdc>
    </encoder>
    <file>${LOG_DIR}/${APP_NAME}-performance.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${LOG_DIR}/${APP_NAME}-performance.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
      <maxFileSize>50MB</maxFileSize>
      <maxHistory>7</maxHistory>
      <totalSizeCap>1GB</totalSizeCap>
    </rollingPolicy>
  </appender>
  <appender class="ch.qos.logback.classic.AsyncAppender" name="ASYNC_PERFORMANCE">
    <appender-ref ref="PERFORMANCE_FILE"/>
    <discardingThreshold>20</discardingThreshold>
    <includeCallerData>false</includeCallerData>
    <maxFlushTime>1000</maxFlushTime>
    <neverBlock>true</neverBlock>
    <queueSize>256</queueSize>
  </appender>

  <!-- Console Appender for Development -->
  <appender class="ch.qos.logback.core.rolling.RollingFileAppender" name="AUDIT_FILE">
    <encoder class="net.logstash.logback.encoder.LogstashEncoder">
      <customFields>{"service":"${APP_NAME}","logType":"audit"}</customFields>
      <includeContext>true</includeContext>
      <includeMdc>true</includeMdc>
    </encoder>
    <file>${LOG_DIR}/${APP_NAME}-audit.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${LOG_DIR}/${APP_NAME}-audit.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
      <maxFileSize>100MB</maxFileSize>
      <maxHistory>365</maxHistory>
      <totalSizeCap>50GB</totalSizeCap>
    </rollingPolicy>
  </appender>

  <!-- Console Appender for Production (JSON format) -->
  <appender class="ch.qos.logback.classic.AsyncAppender" name="ASYNC_AUDIT">
    <appender-ref ref="AUDIT_FILE"/>
    <discardingThreshold>0</discardingThreshold>
    <includeCallerData>false</includeCallerData>
    <maxFlushTime>5000</maxFlushTime>
    <neverBlock>false</neverBlock>
    <queueSize>512</queueSize>
  </appender>

  <!-- File Appender for Application Logs -->
  <jmxConfigurator/>

  <!-- Async File Appender for Performance -->
  <logger additivity="false" level="${LOG_LEVEL}" name="com.inventorymanagement">
    <appender-ref ref="CONSOLE"/>
    <appender-ref ref="ASYNC_FILE"/>
    <appender-ref ref="ASYNC_ERROR_FILE"/>
  </logger>

  <!-- Error File Appender -->
  <logger additivity="false" level="INFO" name="performance">
    <appender-ref ref="ASYNC_PERFORMANCE"/>
  </logger>

  <!-- Async Error File Appender -->
  <logger additivity="false" level="INFO" name="audit">
    <appender-ref ref="ASYNC_AUDIT"/>
  </logger>

  <!-- Performance Log Appender -->
  <logger level="INFO" name="org.springframework"/>

  <!-- Async Performance Appender -->
  <logger level="INFO" name="org.springframework.web"/>

  <!-- Audit Log Appender -->
  <logger level="INFO" name="org.springframework.security"/>

  <!-- Async Audit Appender -->
  <logger level="INFO" name="org.springframework.cache"/>

  <!-- Logger Configurations -->

  <!-- Application Loggers -->
  <logger level="INFO" name="org.springframework.boot.actuator"/>

  <!-- Performance Logger -->
  <logger level="WARN" name="org.hibernate"/>

  <!-- Audit Logger -->
  <logger level="INFO" name="org.hibernate.SQL"/>

  <!-- Spring Framework Loggers -->
  <logger level="TRACE" name="org.hibernate.type.descriptor.sql.BasicBinder"/>
  <logger level="INFO" name="com.zaxxer.hikari"/>
  <logger level="INFO" name="org.flywaydb"/>
  <logger level="WARN" name="org.apache.http"/>
  <logger level="WARN" name="httpclient.wire"/>

  <!-- Database Loggers -->
  <logger level="WARN" name="io.swagger"/>
  <logger level="WARN" name="springfox"/>
  <logger level="WARN" name="net.sf.ehcache"/>
  <logger level="WARN" name="com.github.benmanes.caffeine"/>
  <property name="LOG_DIR" value="${LOG_DIR:-logs}"/>

  <!-- HTTP Client Loggers -->
  <property name="APP_NAME" value="inventory-management-system"/>
  <property name="LOG_PATTERN"
    value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{correlationId:-}] %logger{36} - %msg%n"/>

  <!-- Third-party Libraries -->
  <property name="JSON_PATTERN"
    value='{"timestamp":"%d{yyyy-MM-dd HH:mm:ss.SSS}","level":"%level","thread":"%thread","logger":"%logger{36}","correlationId":"%X{correlationId:-}","message":"%msg","exception":"%ex"}%n'/>
  <root level="${ROOT_LOG_LEVEL}">
    <appender-ref ref="CONSOLE"/>
    <springProfile name="!test">
      <appender-ref ref="ASYNC_FILE"/>
      <appender-ref ref="ASYNC_ERROR_FILE"/>
    </springProfile>
  </root>
  <springProfile name="!prod">
    <property name="LOG_LEVEL" value="DEBUG"/>
    <property name="ROOT_LOG_LEVEL" value="INFO"/>
  </springProfile>
  <springProfile name="prod">
    <property name="LOG_LEVEL" value="INFO"/>
    <property name="ROOT_LOG_LEVEL" value="WARN"/>
  </springProfile>

  <!-- Development Profile Specific Loggers -->
  <springProfile name="!prod">
    <appender class="ch.qos.logback.core.ConsoleAppender" name="CONSOLE">
      <encoder>
        <charset>UTF-8</charset>
        <pattern>${LOG_PATTERN}</pattern>
      </encoder>
    </appender>
  </springProfile>

  <!-- Production Profile Specific Loggers -->
  <springProfile name="prod">
    <appender class="ch.qos.logback.core.ConsoleAppender" name="CONSOLE">
      <encoder class="net.logstash.logback.encoder.LogstashEncoder">
        <customFields>{"service":"${APP_NAME}"}</customFields>
        <includeContext>true</includeContext>
        <includeMdc>true</includeMdc>
      </encoder>
    </appender>
  </springProfile>

  <!-- Root Logger -->
  <springProfile name="dev,test">
    <logger level="DEBUG" name="org.springframework.web"/>
    <logger level="DEBUG" name="org.hibernate.SQL"/>
    <logger level="TRACE" name="org.hibernate.type.descriptor.sql.BasicBinder"/>
    <logger level="DEBUG" name="com.inventorymanagement"/>
  </springProfile>

  <!-- JMX Configuration for Log Level Management -->
  <springProfile name="prod">
    <logger level="WARN" name="org.springframework"/>
    <logger level="WARN" name="org.hibernate"/>
    <logger level="WARN" name="org.apache"/>
    <logger level="INFO" name="com.inventorymanagement"/>
  </springProfile>

  <!-- Status Listener for Logback Internal Events -->
  <statusListener class="ch.qos.logback.core.status.NopStatusListener"/>

</configuration> 